const WPFormsGeolocationMapboxAPI=window.WPFormsGeolocationMapboxAPI||function(r,a){const n=[],i={getFirstFeature(e){return e&&Object.prototype.hasOwnProperty.call(e,"features")&&e.features.length?e.features.shift():null},getFeatureProperties(e){return Object.prototype.hasOwnProperty.call(e,"properties")?e.properties:null},getFeatureProperty(e,t){e=i.getFeatureProperties(e);return Object.prototype.hasOwnProperty.call(e,t)?["region_code","country_code"].includes(t)?e[t].toUpperCase():e[t]:""},getFeatureCoordinates(e){return Object.prototype.hasOwnProperty.call(e,"geometry")&&Object.prototype.hasOwnProperty.call(e.geometry,"coordinates")?{lng:e.geometry.coordinates[0],lat:e.geometry.coordinates[1]}:wpforms_geolocation_settings.default_location},prepareProperties(e){const o={};return e.context.forEach(function(e){var t=e.id.split(".")[0];o[t]=e.text,Object.prototype.hasOwnProperty.call(e,"short_code")&&(o[t+"_code"]=e.short_code.replace(/^US-/,""))}),Object.prototype.hasOwnProperty.call(e,"text")&&(o.address_line1=e.text),Object.prototype.hasOwnProperty.call(e,"address")&&(o.address_line1+=" "+e.address),Object.prototype.hasOwnProperty.call(e,"place_name")&&(o.place_name=e.place_name),o}},o={fetchPlaceData(e,t){const o=new XMLHttpRequest;e.searchParams.set("access_token",wpforms_geolocation_settings.autocompleteSettings.common.access_token),e.searchParams.set("limit","1"),e.searchParams.set("type","address"),o.onreadystatechange=function(){var e;4===o.readyState&&200===o.status&&(e=JSON.parse(o.responseText),e=i.getFirstFeature(e))&&(e.properties=i.prepareProperties(e),t(e))},o.open("GET",e.toString()),o.send()},receivePlace(e,t){e=new URL(`https://api.mapbox.com/geocoding/v5/mapbox.places/${e.lng},${e.lat}.json`);this.fetchPlaceData(e,t)},receivePlaceByQuery(e,t){e=new URL(`https://api.mapbox.com/geocoding/v5/mapbox.places/${e}.json`);this.fetchPlaceData(e,t)}},s={getStateCoordinates(e,t){return e.settings.autocompleteSettings.strict&&(e=e.settings.autocompleteSettings.strict.toString().toLowerCase(),Object.prototype.hasOwnProperty.call(wpforms_geolocation_settings.states,e))&&Object.prototype.hasOwnProperty.call(wpforms_geolocation_settings.states[e],t)?wpforms_geolocation_settings.states[e][t]:null}},l={init(){"loading"===r.readyState?a.addEventListener("load",l.ready):l.ready()},ready(){l.getFields(),n.length&&(l.events(),l.initFieldPlaceMaps(),l.detectGeolocation())},events(){r.onwpformsProcessConditionalsField=function(e,t,o){t=r.getElementById("wpforms-"+t+"-field_"+o);t&&t.hasAttribute("data-autocomplete")&&a.dispatchEvent(new Event("resize"))},r.onwpformsRepeaterFieldCloneCreated=function(){l.getFields(),l.initFieldPlaceMaps(),l.detectGeolocation()}},initFieldPlaceMaps(){n.forEach(function(e){e.map||(l.initMap(e),l.initAutocomplete(e))})},showDebugMessage(e){a.location.hash&&"#wpformsdebug"===a.location.hash&&console.log(e)},getFields(){Array.prototype.slice.call(r.querySelectorAll('.wpforms-form .wpforms-field input[type="text"][data-autocomplete="1"]')).forEach(function(e){var t=e.closest(".wpforms-field"),o=e.hasAttribute("data-display-map")?t.querySelector(".wpforms-geolocation-map"):null,a=t.classList[1]?t.classList[1].replace("wpforms-field-",""):"text";let s={};"address"===a&&(s={address_line1:t.querySelector(".wpforms-field-address-address1"),address_line2:t.querySelector(".wpforms-field-address-address2"),place:t.querySelector(".wpforms-field-address-city"),postcode:t.querySelector(".wpforms-field-address-postal"),country_code:t.querySelector(".wpforms-field-address-country")},"SELECT"===(t=t.querySelector(".wpforms-field-address-state")).tagName?s.region_code=t:s.region=t);t=e.getAttribute("id");l.placeAlreadyAdded(t)||n.push({fieldID:t,searchField:e,mapField:o,type:a,additionalFields:s,settings:l.getFieldSettings(e)})})},placeAlreadyAdded(t){return n.some(function(e){return e.fieldID===t})},getFieldSettings(e){e=e.getAttribute("id").replaceAll("-","_");return{autocompleteSettings:l.getFieldAutocompleteSettings(e),mapSettings:l.getFieldMapSettings(e),markerSettings:l.getFieldMarkerSettings(e)}},getFieldAutocompleteSettings(e){return Object.assign({},wpforms_geolocation_settings.autocompleteSettings.common||{},wpforms_geolocation_settings.autocompleteSettings[e]||{})},getFieldMapSettings(e){return Object.assign({trackResize:!0},wpforms_geolocation_settings.mapSettings.common||{},wpforms_geolocation_settings.mapSettings[e]||{})},getFieldMarkerSettings(e){return Object.assign({draggable:!0},wpforms_geolocation_settings.markerSettings.common||{},wpforms_geolocation_settings.markerSettings[e]||{})},initMap(t){var e,o,a;!t.mapField||t.mapField.classList.contains("mapboxgl-map")||(e=t.mapField.closest(".elementor-location-popup"))&&!e.offsetParent||(mapboxgl.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token,t.map=new mapboxgl.Map(Object.assign({container:t.mapField},t.settings.mapSettings)),t.map.addControl(new mapboxgl.NavigationControl),t.marker=new mapboxgl.Marker(t.settings.markerSettings).setLngLat([t.settings.mapSettings.center.lng,t.settings.mapSettings.center.lat]).addTo(t.map),t.marker.on("dragend",l.markerChanged),e=new MutationObserver(function(e){e.forEach(function(){t.map.resize()})}),a=(o=t.mapField).closest(".wpforms-page"),e.observe(o.parentElement,{attributes:!0,attributeFilter:["style"]}),a&&e.observe(a,{attributes:!0,attributeFilter:["style"]}))},updateMap(e,t){e.map&&e.marker&&(t=i.getFeatureCoordinates(t),e.marker.setLngLat([t.lng,t.lat]),e.map.setCenter([t.lng,t.lat]))},markerChanged(){const t=l.findFieldPlaceBy("map",this._map);t&&o.receivePlace(this.getLngLat(),function(e){l.updateMap(t,e),l.updateFields(t,e)})},findFieldPlaceBy(t,o){let a=null;return n.some(function(e){return!!(Object.prototype.hasOwnProperty.call(e,t)&&e[t]===o||e.additionalFields&&Object.prototype.hasOwnProperty.call(e.additionalFields,t)&&e.additionalFields[t]===o)&&(a=e,!0)}),a},initAutocomplete(t){mapboxsearch.config.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token;var e=r.createElement("mapbox-address-autofill");e.append(t.searchField.cloneNode(!0)),t.searchField.replaceWith(e),e.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token,e.options=t.settings.autocompleteSettings,e.theme={cssText:`
					.Results {
						z-index: 10000;
					}
				`},t.autocomplete=e,t.searchField=e.querySelector("input"),t.autocomplete.addEventListener("retrieve",l.updateFieldPlace),t.autocomplete.addEventListener("keydown",l.preventSubmitOnPressEnter),t.searchField.value&&o.receivePlaceByQuery(t.searchField.value,function(e){l.updateMap(t,e)}),"address"===t.type&&(t.additionalFields.address_line1=t.searchField,l.bindAddressFieldEvents(t))},bindAddressFieldEvents(e){var t;e.additionalFields.country_code&&e.additionalFields.country_code.addEventListener("change",l.updateCountry),e.settings.autocompleteSettings.strict&&(t=Array.isArray(e.settings.autocompleteSettings.strict)?e.settings.autocompleteSettings.strict[0]:e.settings.autocompleteSettings.strict,e.settings.autocompleteSettings.strict=t,e.autocomplete.options.country=t?t.toString().toUpperCase():"",e.additionalFields.region_code.addEventListener("change",l.updateArea))},updateFieldPlace(e){var t=l.findFieldPlaceBy("autocomplete",e.target);t&&(e=i.getFirstFeature(e.detail),l.updateFields(t,e),l.updateMap(t,e))},preventSubmitOnPressEnter(e){13===e.keyCode&&e.target.ariaExpanded&&e.stopPropagation()},updateFields(e,t){"text"===e.type?l.updateTextField(e,t):"address"===e.type&&l.updateAddressField(e,t),l.showDebugMessage("Fields was updated"),l.showDebugMessage(e),l.showDebugMessage(t)},updateTextField(e,t){e.searchField.value=i.getFeatureProperty(t,"place_name"),l.triggerEvent(e.searchField,"change")},updateAddressField(e,t){l.clearAdditionalFields(e);for(var[o,a]of Object.entries(e.additionalFields)){var s=i.getFeatureProperty(t,o);s&&(a||"country_code"!==o?a&&(l.isConversationalSelect(a)?l.updateConversationalSelect(a,s):(a.value=s,l.triggerEvent(a,"change"))):r.dispatchEvent(new CustomEvent("wpforms-geolocation-absent-country-changed",{detail:{stateInputElement:e.additionalFields.region,shortName:s}})))}},isConversationalSelect(e){return"SELECT"===e.tagName&&Boolean(e.closest(".wpforms-conversational-select"))},updateConversationalSelect(e,t){var o=e.closest(".wpforms-conversational-select"),a=e.querySelector('option[value="'+t+'"]'),o=o.querySelector(".wpforms-conversational-form-dropdown-input input");e.value=t,l.triggerEvent(e,"change"),a&&o&&(o.value=a.innerText)},triggerEvent(e,t){t=new Event(t,{bubbles:!0,cancelable:!0});e.dispatchEvent(t)},clearAdditionalFields(e){e.additionalFields&&Object.values(e.additionalFields).forEach(function(e){e&&(e.value="")})},updateCountry(){var e,t=l.findFieldPlaceBy("country_code",this);t&&t.autocomplete&&(e=this.value.toString().toUpperCase(),t.autocomplete.options.country=e,l.showDebugMessage("Autocomplete field restrict to country: "+e))},updateArea(){var e=l.findFieldPlaceBy("region_code",this),t=this.value.toString().toUpperCase(),o=s.getStateCoordinates(e,t);l.showDebugMessage("Autocomplete field try to find the "+t+" state"),e&&t&&o||l.showDebugMessage("Autocomplete field doesn't restrict to the "+t+" state"),e.autocomplete.options.proximity=o,l.showDebugMessage("Autocomplete field restrict to the "+t+" state")},detectGeolocation(){wpforms_geolocation_settings.current_location&&navigator.geolocation&&n&&navigator.geolocation.getCurrentPosition(function(e){e={lat:e.coords.latitude.toFixed(6),lng:e.coords.longitude.toFixed(6)};o.receivePlace(e,function(a){n.forEach(function(e,t){var o;e.currentGeolocationInited||(o=e.searchField.closest(".wpforms-field"))&&o.classList.contains("wpforms-conditional-hide")||(l.updateMap(e,a),l.updateFields(e,a),n[t].currentGeolocationInited=!0)})})})}};return l}(document,window);WPFormsGeolocationMapboxAPI.init(),window.addEventListener("elementor/popup/show",WPFormsGeolocationMapboxAPI.init)
;