WPForms.Admin.Builder.Providers.GoogleDrive=WPForms.Admin.Builder.Providers.GoogleDrive||((e,o,l)=>{let s={selectors:{panel:".wpforms-builder-provider",formNameField:"#wpforms-panel-field-settings-form_title",settingsPanel:"#wpforms-panel-settings",connectionAddBtn:".js-wpforms-builder-provider-connection-add",authButton:"#wpforms-google-drive-sign-in .gsi-material-button",connection:".wpforms-builder-provider-connection",connections:".wpforms-builder-provider-connections",fieldWrapper:".wpforms-builder-provider-connection-block",accountField:".js-wpforms-builder-google-drive-provider-connection-account",accountFields:".js-wpforms-builder-google-drive-provider-account-fields",folderTypeField:".js-wpforms-builder-google-drive-provider-connection-folder-type",folderTypeBlock:".wpforms-builder-google-drive-provider-folder-type .wpforms-builder-provider-connection-block-field",folderTypeRequired:".wpforms-builder-google-drive-provider-folder-type .required",folderIdField:".js-wpforms-builder-google-drive-provider-connection-folder-id",folderIdFieldChoose:".js-wpforms-builder-google-drive-provider-connection-folder-id-choose",folderIdFieldEmpty:".js-wpforms-builder-provider-connection-block-field-existing-empty",folderIdFieldNotEmpty:".js-wpforms-builder-provider-connection-block-field-existing-not-empty",folderViewBtn:".js-wpforms-builder-google-drive-provider-connection-folder-id-view",folderRemoveBtn:".js-wpforms-builder-google-drive-provider-connection-folder-id-remove",folderNameField:".js-wpforms-builder-google-drive-provider-connection-folder-name",deleteLocalFilesField:".js-wpforms-builder-google-drive-provider-connection-delete-local-files",deleteLocalFilesNotice:".wpforms-alert",restrictedFileUploadFields:".wpforms-file-upload-access-restrictions:checked",innerGroup:".wpforms-field-option-group-inner",restrictedFileUploadType:".wpforms-file-upload-user-restrictions",restrictedFileUploadPassword:".wpforms-file-upload-password-restrictions:checked",choiceJS:".choicesjs-select",DropboxPanel:"#dropbox-provider",DropboxAuthorizeButton:".wpforms-builder-accounts-dropbox-authorize-button",defaultContent:".wpforms-builder-provider-settings-default-content",compatibilityContent:".wpforms-builder-provider-settings-compatibility-content",GoogleSheetsPanel:"#google-sheets-provider"},classes:{hideBtn:"hidden",hide:"wpforms-hidden",required:"wpforms-required",filesField:"js-wpforms-builder-google-drive-provider-connection-fields"},$elements:{$builder:l("#wpforms-builder"),$panel:l("#google-drive-provider"),$connections:l("#google-drive-provider .wpforms-builder-provider-connections")},provider:"google-drive",Providers:{},Templates:{},Cache:{},isReady:!1,init(){"settings"===wpf.getQueryString("view")&&l(s.selectors.settingsPanel).on("WPForms.Admin.Builder.Providers.ready",s.ready),l(e).on("wpformsPanelSwitched",function(e,o){"settings"===o&&s.ready()})},ready(){s.isReady||(s.Providers=WPForms.Admin.Builder.Providers,s.Templates=WPForms.Admin.Builder.Templates,s.Cache=s.Providers.cache,s.Templates.add(["wpforms-google-drive-builder-content-connection","wpforms-google-drive-builder-content-connection-error","wpforms-google-drive-builder-content-connection-conditionals"]),s.bindUIActions(),s.bindTriggers(),s.processInitial(),s.compatibility.Dropbox.init(),s.compatibility.GoogleSheets.init(),gapi.load("picker"),s.isReady=!0)},bindUIActions(){s.$elements.$panel.on("connectionCreate",s.connection.create).on("connectionDelete",s.connection.delete).on("change",s.selectors.accountField,s.ui.accountField.change).on("click",s.selectors.authButton,s.account.add).on("change",s.selectors.folderTypeField,s.ui.folderTypeField.changeType).on("click",s.selectors.folderIdFieldChoose,s.ui.folderIdField.openPicker).on("click",s.selectors.folderRemoveBtn,s.ui.folderIdField.clear).on("input",s.selectors.folderIdField,s.ui.folderIdField.changeState).on("input",s.selectors.formNameField,s.ui.folderNameField.update).on("input",s.selectors.folderNameField,s.ui.folderNameField.change).on("input",s.selectors.folderIdField,s.ui.fileLink.update).on("change",s.selectors.deleteLocalFilesField,s.ui.deleteFilesField.change),s.$elements.$builder.on("wpformsFieldSelectMapped",s.ui.filesField.update).on("wpformsSaved",s.connection.refresh)},bindTriggers(){s.$elements.$connections.on("connectionsDataLoaded",function(e,o){if(!_.isEmpty(o.connections))for(var i in o.connections)s.connection.renderConnections({connection:o.connections[i],conditional:o.conditionals[i]})}),s.$elements.$connections.on("connectionGenerated",function(e,o){var i=s.connection.getById(o.connection.id);_.has(o.connection,"isNew")&&o.connection.isNew?(s.ui.deleteFilesField.defaultValueForNewConnection(i),s.connection.replaceIds(o.connection.id,i)):l(s.selectors.folderIdField,i).trigger("input",[i])})},processInitial(){var e=s.Templates.get(`wpforms-${s.provider}-builder-content-connection-error`);s.$elements.$connections.prepend(e()),s.connection.dataLoad()},connection:{getById(e){return s.$elements.$connections.find('.wpforms-builder-provider-connection[data-connection_id="'+e+'"]')},replaceIds(o,e){e.find("input, select, label").each(function(){var e=l(this);e.attr("name")&&e.attr("name",e.attr("name").replace(/%connection_id%/gi,o)),e.attr("id")&&e.attr("id",e.attr("id").replace(/%connection_id%/gi,o)),e.attr("for")&&e.attr("for",e.attr("for").replace(/%connection_id%/gi,o)),e.attr("data-name")&&e.attr("data-name",e.attr("data-name").replace(/%connection_id%/gi,o))})},create(e,o){var i=(new Date).getTime().toString(16),o={id:i,name:o,isNew:!0};s.Cache.addTo(s.provider,"connections",i,o),s.connection.renderConnections({connection:o})},delete(e,o){var i=s.Providers.getProviderHolder(s.provider);o.closest(i).length&&(i=o.data("connection_id"),_.isString(i)&&s.Cache.deleteFrom(s.provider,"connections",i),s.$elements.$connections.trigger("connectionDeleted"))},renderConnections(e){var o,i,t,n,r=s.Cache.get(s.provider,"accounts");s.account.isExists(e.connection.account_id,r)&&(o=s.Templates.get(`wpforms-${s.provider}-builder-content-connection`),i=l(s.selectors.formNameField).val(),t=l(`#tmpl-wpforms-${s.provider}-builder-content-connection-conditionals`).length?s.Templates.get(`wpforms-${s.provider}-builder-content-connection-conditionals`):s.Templates.get("wpforms-providers-builder-content-connection-conditionals"),t=_.has(e.connection,"isNew")&&e.connection.isNew?t():e.conditional,n=wpf.getFields(["file-upload"],!0),s.$elements.$connections.prepend(o({formName:i,fileUploadFields:n,accounts:r,connection:e.connection,conditional:t,provider:s.provider})),s.$elements.$connections.trigger("connectionGenerated",[e]),s.ui.initChoicesJS(s.connection.getById(e.connection.id)),s.$elements.$connections.trigger("connectionRendered",[s.provider,e]))},dataLoad(){s.Providers.ajax.request(s.provider,{data:{task:"connections_get"}}).done(function(e){e.success&&_.has(e.data,"connections")&&(s.connection.updateCache(e.data),s.$elements.$connections.trigger("connectionsDataLoaded",[e.data]))})},updateCache(o){["connections","conditionals","accounts"].forEach(e=>{s.Cache.set(s.provider,e,jQuery.extend({},o[e]))})},refresh(e,o){Object.hasOwn(o,s.provider)&&(o=o[s.provider],_.has(o,"connections"))&&(s.connection.updateCache(o),s.$elements.$connections.html(""),s.$elements.$connections.trigger("connectionsDataLoaded",[o]))}},account:{isExists(e,o){return!_.isEmpty(o)&&(!!_.isEmpty(e)||_.has(o,e))},add(e){e.preventDefault(),WPFormsBuilder.formIsSaved()?o.location.href=wpforms_builder.google_drive.auth_url:(wpforms_builder.exit_url=wpforms_builder.google_drive.auth_url,WPFormsBuilder.formSave(!0))}},ui:{accountField:{change(){var e=l(this),o=e.closest(s.selectors.connection);l(s.selectors.accountFields,o).toggleClass(s.classes.hide,""===e.val()),l(s.selectors.folderIdField,o).val("").trigger("input")}},folderTypeField:{changeType(){var e=l(this),o="new"===e.val(),e=e.closest(s.selectors.connection),i=l(s.selectors.folderIdField,e),t=i.closest(s.selectors.fieldWrapper),n=l(s.selectors.folderNameField,e),r=n.closest(s.selectors.fieldWrapper);l(s.selectors.folderTypeRequired,e).toggleClass(s.classes.hide,o),t.toggleClass(s.classes.hide,o),i.toggleClass(s.classes.required,!o),r.toggleClass(s.classes.hide,!o),n.toggleClass(s.classes.required,o)}},folderIdField:{openPicker(){let i=l(this).closest(s.selectors.connection);s.Providers.ajax.request(s.provider,{data:{task:"access_token_get",account_id:l(s.selectors.accountField,i).val()}}).done(function(e){var o;_.has(e,"data")&&_.has(e.data,"access_token")&&(o=new google.picker.DocsView(google.picker.ViewId.FOLDERS).setMode(google.picker.DocsViewMode.LIST).setSelectFolderEnabled(!0),wpforms_builder.google_drive.enabled_shared_drives||o.setOwnedByMe(!0),(new google.picker.PickerBuilder).setOAuthToken(e.data.access_token).addView(o).hideTitleBar().enableFeature(google.picker.Feature.NAV_HIDDEN).setCallback(function(e){var o;e.action===google.picker.Action.PICKED&&(o=l(s.selectors.folderIdField,i),e=e[google.picker.Response.DOCUMENTS][0][google.picker.Document.ID],o.val(e).trigger("input"))}).build().setVisible(!0))})},clear(){l(this).closest(s.selectors.connection).find(s.selectors.folderIdField).val("").trigger("input")},changeState(){var e=l(this),o=e.val(),o=""===o||null===o,e=e.closest(s.selectors.connection),i=l(s.selectors.folderIdFieldEmpty,e),t=l(s.selectors.folderIdFieldNotEmpty,e);l(s.selectors.folderTypeBlock,e).toggleClass(s.classes.hide,!o),i.toggleClass(s.classes.hide,!o),t.toggleClass(s.classes.hide,o)}},folderNameField:{update(){var e=l(this).val(),o=l(s.selectors.folderNameField);o.attr("placeholder",e),o.data("changed")&&""!==o.val()||o.val(e)},change(){var e=l(this);e.data("changed")||e.val()!==e.data("default")&&l(this).data("changed",!0)}},filesField:{update(e,i){if(i.hasClass(s.classes.filesField)){let o=i.data("choicesjs");if(o){let e=s.ui.filesField.getSelectFieldChoices(i);var t=o.getValue(!0).filter(o=>e.some(e=>e.value===o));0===t.length&&(o.destroy(),i.removeData("choicesjs"),s.ui.initChoicesJS(i.closest(s.selectors.connection)),o=i.data("choicesjs")),o.clearChoices(!0,!0).removeActiveItems().setChoices(e,"value","label",!0).setChoiceByValue(t)}}},getSelectFieldChoices(e){let i=[];return e.find("option").each(function(){var e=l(this),o=e.val();""!==o&&i.push({value:o,label:e.text()})}),i}},fileLink:{update(){var e=l(this).closest(s.selectors.connection),o=l(s.selectors.folderTypeField+":checked",e).val(),i=l(s.selectors.folderIdField,e).val();i&&"new"!==o&&l(s.selectors.folderViewBtn,e).attr("href",s.ui.fileLink.getUrl(i))},getUrl(e){return"https://drive.google.com/drive/u/0/folders/"+e}},deleteFilesField:{defaultValueForNewConnection(e){var o=l(s.selectors.deleteLocalFilesField,e),e=e.data("connection_id"),e=s.$elements.$connections.find(s.selectors.connection+':not([data-connection_id="'+e+'"])').find(s.selectors.deleteLocalFilesField).is(":checked");o.prop("checked",e)},change(e){e.preventDefault(),s.$elements.$connections.find(s.selectors.deleteLocalFilesField).length<=1||s.ui.deleteFilesField.confirmationModal(!l(this).is(":checked"))},confirmationModal(e){let o=s.$elements.$connections.find(s.selectors.deleteLocalFilesField);l.confirm({title:wpforms_builder.heads_up,content:wpforms_builder.google_drive.delete_local_files_prompt,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.google_drive.delete_local_files_confirm,btnClass:"btn-confirm",keys:["enter"],action(){o.prop("checked",!e),s.compatibility.GoogleSheets.updateVisibility()}},cancel:{text:wpforms_builder.cancel,btnClass:"btn-cancel",action(){o.prop("checked",e),s.compatibility.GoogleSheets.updateVisibility()}}}})}},initChoicesJS(e){"function"==typeof o.Choices&&l(s.selectors.choiceJS,e).each(function(e,o){o=l(o);void 0===o.data("choicesjs")&&o.data("choicesjs",new Choices(o[0],{shouldSort:!1,removeItemButton:!0,fuseOptions:{threshold:.1,distance:1e3},callbackOnInit(){wpf.initMultipleSelectWithSearch(this),wpf.showMoreButtonForChoices(this.containerOuter.element)}}))})}},compatibility:{Dropbox:{provider:"dropbox",isConfigured(){var e;return 0===s.$elements.$panel.find(s.selectors.authButton).length&&!!(e=l(s.selectors.DropboxPanel)).length&&!e.find(s.selectors.DropboxAuthorizeButton).length},init(){var e,o;s.compatibility.Dropbox.isConfigured()&&(o=(e=s.$elements.$panel.add(s.selectors.DropboxPanel)).find(s.selectors.connections),s.compatibility.Dropbox.lockButton(s.provider),s.compatibility.Dropbox.lockButton(s.compatibility.Dropbox.provider),o.on("connectionsDataLoaded",s.compatibility.Dropbox.dataLoaded).on("connectionGenerated",s.compatibility.Dropbox.lockNew),e.on("connectionDelete",s.compatibility.Dropbox.unlockDelete))},getElementProvider(e){return e.closest(s.selectors.panel).data("provider")},getLinkedProvider(e){return(e===s.provider?s.compatibility.Dropbox:s).provider},unlock(e){var e=s.Providers.getProviderHolder(e),o=e.find(s.selectors.defaultContent),i=e.find(s.selectors.compatibilityContent);e.find(s.selectors.connectionAddBtn).removeClass(s.classes.hideBtn),o.removeClass(s.classes.hide),i.addClass(s.classes.hide)},lockMessage(e){var o=s.Providers.getProviderHolder(e),i=o.find(s.selectors.defaultContent),o=o.find(s.selectors.compatibilityContent);i.addClass(s.classes.hide),o.length?o.removeClass(s.classes.hide):(o=e===s.provider?wpforms_builder.google_drive.google_drive_compatibility_message:wpforms_builder.google_drive.dropbox_compatibility_message,e=s.selectors.compatibilityContent.substring(1),i.after(`<p class="${e}">${o}</p>`))},lockButton(e){s.Providers.getProviderHolder(e).find(s.selectors.connectionAddBtn).addClass(s.classes.hideBtn)},dataLoaded(e,o){var i=s.compatibility.Dropbox.getElementProvider(l(this));i!==s.provider&&i!==s.compatibility.Dropbox.provider||(i=s.compatibility.Dropbox.getLinkedProvider(i),_.isEmpty(o.connections)?s.compatibility.Dropbox.unlock(i):s.compatibility.Dropbox.lockMessage(i))},unlockDelete(){var e=s.compatibility.Dropbox.getElementProvider(l(this)),o=s.Cache.get(e,"connections");_.isEmpty(o)&&s.compatibility.Dropbox.unlock(s.compatibility.Dropbox.getLinkedProvider(e))},lockNew(e,o){_.has(o.connection,"isNew")&&o.connection.isNew&&(o=s.compatibility.Dropbox.getLinkedProvider(s.compatibility.Dropbox.getElementProvider(l(this))),s.compatibility.Dropbox.lockButton(o),s.compatibility.Dropbox.lockMessage(o))}},GoogleSheets:{init(){var e,o;s.compatibility.GoogleSheets.isConfigured()&&(e=l(s.selectors.GoogleSheetsPanel),o=s.$elements.$panel.find(s.selectors.connections),s.$elements.$panel.on("change",s.compatibility.GoogleSheets.updateVisibility),s.$elements.$builder.on("wpformsPanelSwitch",s.compatibility.GoogleSheets.switchPanel).on("wpformsPanelSectionSwitch",s.compatibility.GoogleSheets.switchSection),e.on("connectionGenerated",s.compatibility.GoogleSheets.updateVisibility),o.on("connectionGenerated",s.compatibility.GoogleSheets.updateVisibility))},isConfigured(){return!l(s.selectors.GoogleSheetsPanel).find(s.selectors.connectionAddBtn).hasClass(s.classes.hideBtn)},isFormHasRestrictedFields(){var e=l(s.selectors.restrictedFileUploadFields);if(!e.length)return!1;let o=!1;return e.each(function(){var e=l(this).closest(s.selectors.innerGroup);if("none"!==e.find(s.selectors.restrictedFileUploadType).val()||e.find(s.selectors.restrictedFileUploadPassword).length)return!(o=!0)}),o},updateVisibility(){var e=s.compatibility.GoogleSheets.isFormHasRestrictedFields(),o=Boolean(l(s.selectors.GoogleSheetsPanel).find(s.selectors.connection).length),i=l(s.selectors.deleteLocalFilesField).is(":checked");l(s.selectors.deleteLocalFilesNotice,s.$elements.$connections).toggleClass(s.classes.hide,!e||!o||!i)},switchPanel(e,o){"settings"===o&&s.compatibility.GoogleSheets.updateVisibility()},switchSection(e,o){o===s.provider&&s.compatibility.GoogleSheets.updateVisibility()}}}};return s})(document,window,jQuery),WPForms.Admin.Builder.Providers.GoogleDrive.init();