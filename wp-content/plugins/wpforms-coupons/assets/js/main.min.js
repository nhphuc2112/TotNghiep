const WPFormsCoupons=window.WPFormsCoupons||function(e,l,i){const u={cache:{},selectors:{applyButton:".wpforms-field-payment-coupon-button",couponInput:".wpforms-field-payment-coupon-input",removeCouponButton:".wpforms-field-payment-coupon-applied-item-remove",couponRow:".wpforms-field-payment-coupon-wrapper",appliedCouponsWrapper:".wpforms-field-payment-coupon-applied-coupons",appliedCouponItem:".wpforms-field-payment-coupon-applied-item",field:".wpforms-field",form:".wpforms-form",errorMessage:"em.wpforms-error, label.wpforms-error",errorField:".wpforms-error",payPalCommerceNotice:".wpforms-coupons-paypal-commerce-notice"},classes:{hasAppliedCoupons:"wpforms-field-payment-coupon-wrapper-applied",fieldHasError:"wpforms-has-error",error:"wpforms-error",applyingCoupon:"wpforms-field-payment-coupon-wrapper-applying",payPalCommerceNoticeClass:"wpforms-coupons-paypal-commerce-notice"},init(){i(u.ready),i(l).on("load",function(){"function"==typeof i.ready.then?i.ready.then(u.load):u.load()})},ready(){u.registerValidationMethod(),u.bindEvents()},bindEvents(){i(e).on("click",u.selectors.applyButton,u.applyButtonClick).on("keydown",u.selectors.couponInput,u.inputPressEnter).on("click",u.selectors.removeCouponButton,u.removeCoupon).on("wpformsAmountTotalCalculate",u.recalculateTotal).on("input",u.selectors.couponInput,u.resetField)},registerValidationMethod(){void 0!==i.fn.validate&&i.validator.addMethod("coupon",function(e,o){var s=i(o);if(s.val().length){var r=s.closest("form").data("formid");if(!Object.prototype.hasOwnProperty.call(u.cache,r)||!Object.prototype.hasOwnProperty.call(u.cache[r],e))return u.showDebugMessage("Send coupon validation request"),u.applyCouponRequest(o,e),"pending";u.showDebugMessage("Validation coupon from cache");o=u.cache[r][e];if("object"!=typeof o)return u.showDebugMessage("The "+e+" coupon is invalid"),!1;r=s.closest(u.selectors.field);u.applyCouponSuccess(r,o.formatted_code,o.value,o.type),u.showDebugMessage("Coupon successfully applied"),u.showDebugMessage(o)}return!0},wpforms_settings.val_invalid_coupon)},applyCouponRequest(o,s){var e=i(o),r=e.closest("form");const t=r.data("validator"),a=r.data("formid"),p=e.closest(u.selectors.field),n=p.find(u.selectors.couponRow);u.cache[a]=u.cache[a]||{},t.startRequest(o),i.ajax({type:"POST",url:wpforms_settings.ajaxurl,mode:"abort",port:"validate"+o.name,data:{action:"wpforms_coupons_apply_coupon",form_id:a,coupon_code:s},dataType:"json",async:!1,beforeSend(){n.addClass(u.classes.applyingCoupon)},success(e){t.stopRequest(o,!0),u.cache[a][s]=e.data,u.applyCouponSuccess(p,e.data.formatted_code,e.data.value,e.data.type),u.showDebugMessage("Coupon successfully applied"),u.showDebugMessage(e.data)},error(){t.stopRequest(o,!1),u.showError(p,wpforms_settings.val_invalid_coupon),u.cache[a][s]=!1,u.showDebugMessage("The "+s+" coupon is invalid")},complete(){n.removeClass(u.classes.applyingCoupon)}})},load(){i(u.selectors.couponInput).each(function(){var e=i(this);u.isEmptyField(e)||e.trigger("focusout")})},isEmptyField(e){return 0<!e.val().trim().length},inputPressEnter(e){13===e.keyCode&&(e.preventDefault(),i(this).closest(u.selectors.field).find(u.selectors.applyButton).trigger("focus"))},applyButtonClick(e){e.preventDefault()},applyCouponSuccess(e,o,s,r){var t=e.find(u.selectors.appliedCouponsWrapper),a=e.find(u.selectors.couponInput),p=e.find(u.selectors.applyButton),n=e.find(u.selectors.couponRow),l=e.closest(u.selectors.form),e=(e.removeClass(u.classes.fieldHasError),e.find(u.selectors.errorMessage).remove(),e.find(u.selectors.errorField).removeClass(u.classes.error),a.prop("disabled",!0).prop("required",!1),p.prop("disabled",!0),n.addClass(u.classes.hasAppliedCoupons),u.getFormattedValue(s,r));t.html('<div class="wpforms-field-payment-coupon-applied-item" data-value="'+s+'" data-type="'+r+'"><button type="button" aria-live="assertive" aria-label="'+wpforms_settings.remove_coupon_icon_text+'" class="wpforms-field-payment-coupon-applied-item-remove"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none"><path fill="#D63637" d="M7 .469A6.78 6.78 0 0 0 .219 7.25 6.78 6.78 0 0 0 7 14.031a6.78 6.78 0 0 0 6.781-6.781A6.78 6.78 0 0 0 7 .469Zm3.309 8.586c.136.11.136.328 0 .465l-1.067 1.066c-.137.137-.355.137-.465 0L7 8.78l-1.805 1.805c-.11.137-.328.137-.465 0L3.664 9.492c-.137-.11-.137-.328 0-.465L5.47 7.25 3.664 5.473c-.137-.11-.137-.328 0-.465L4.758 3.94c.11-.136.328-.136.465 0L7 5.72 8.777 3.94c.11-.136.328-.136.465 0l1.067 1.067c.136.137.136.355 0 .465L8.53 7.25l1.778 1.805Z"/></svg></button><span class="wpforms-field-payment-coupon-applied-item-code">'+o+" (-"+e+')</span><input type="hidden" class="wpforms-field-skip-validation" name="'+a.attr("name")+'" value="'+o+'"/></div>'),wpforms.amountTotal(l,!1),l.find(".wpforms-payment-total").trigger("input")},updateOrderSummary(e,a,p,n,l,c){e.find(".wpforms-order-summary-preview").each(function(){var e=i(this),o=e.find(".wpforms-order-summary-preview-subtotal"),s=e.find(".wpforms-order-summary-preview-coupon-total"),r=wpforms_settings.summary_coupon_name.replace(/%name%/g,n);let t=u.getFormattedValue(a,p);"percentage"===p&&(t=`${t} (${wpforms.amountFormatSymbol(c)})`),o.show(),s.show(),o.find(".wpforms-order-summary-item-price").text(wpforms.amountFormatSymbol(l)),s.find(".wpforms-order-summary-item-label").text(r),s.find(".wpforms-order-summary-item-price").text("-"+t);o=Math.max(t.length+2,e.find(".wpforms-order-summary-preview-total .wpforms-order-summary-item-price").text().length+3);e.find(".wpforms-order-summary-item-price").css("width",o+"ch")})},getFormattedValue(e,o){if("percentage"===o)return e+"%";e=wpforms.amountFormat(e);o=wpforms.getCurrency();return"left"===o.symbol_pos?o.symbol+e:e+" "+o.symbol},recalculateTotal(e,r,t){let a=0;r.find(u.selectors.appliedCouponItem).each(function(){var e=i(this),o=e.data("value"),s=e.data("type"),e=e.find('input[type="hidden"]').val();a+="percentage"!==s?o:t/100*o,u.updateOrderSummary(r,o,s,e,t,a)});var o,e=void 0!==e.result?e.result:t;return 0===a?e:(o=wpforms.getCurrency(),a=wpforms.numberFormat(a,o.decimals,".",""),u.showDebugMessage("Total was recalculated. Discount: "+a),Math.max(0,Number(e)-Number(a)))},showError(e,o){var s,r,t=e.closest(u.selectors.form).data("validator");t&&((r={})[s=(e=e.find(u.selectors.couponInput)).attr("name")]=o,delete t.invalid[s],t.resetElements(e),t.showErrors(r))},removeCoupon(){var e=i(this).closest(u.selectors.field),o=e.closest(u.selectors.form),s=e.find(u.selectors.appliedCouponItem),r=e.find(u.selectors.applyButton),t=e.find(u.selectors.couponInput),a=t.val(),p=e.find(u.selectors.couponRow),n=t.hasClass("wpforms-field-required");t.val("").prop("disabled",!1).prop("required",n),r.prop("disabled",!1),p.removeClass(u.classes.hasAppliedCoupons),s.remove(),wpforms.amountTotal(o,!1),e.hasClass("wpforms-conditional-trigger")&&l.wpformsconditionals.processConditionals(o,!1),o.find(".wpforms-order-summary-preview").each(function(){var e=i(this),o=e.find(".wpforms-order-summary-preview-subtotal"),s=e.find(".wpforms-order-summary-preview-coupon-total"),o=(o.hide(),s.hide(),o.find(".wpforms-order-summary-item-price").text(""),s.find(".wpforms-order-summary-item-price").text(""),e.find(".wpforms-order-summary-preview-total td:last-child").text().length+3);e.find(".wpforms-order-summary-item-price").css("width",o+"ch")}),u.showDebugMessage("The "+a+" coupon was removed")},resetField(){u.isEmptyField(i(this))&&i(this).closest(u.selectors.field).find(u.selectors.removeCouponButton).click()},showDebugMessage(e){l.location.hash&&"#wpformsdebug"===l.location.hash&&console.log(e)},applyCoupon(p){return console.warn('WARNING! Function "WPFormsCoupons.applyCoupon( $field )" has been deprecated, please use the new "WPFormsCoupons.applyCouponRequest: function( element, value )" function instead!'),new Promise(function(o,s){const e=p.find(u.selectors.couponRow);if(e.hasClass(u.classes.hasAppliedCoupons))o(!0);else{var r,t=p.find(u.selectors.couponInput).val().trim();const a=wpforms_settings.val_invalid_coupon;t?(r=p.closest(u.selectors.form).data("formid"),i.ajax({type:"POST",url:wpforms_settings.ajaxurl,data:{action:"wpforms_coupons_apply_coupon",form_id:r,coupon_code:t},dataType:"json",beforeSend(){e.addClass(u.classes.applyingCoupon)},success(e){e.success&&e.data&&e.data.formatted_code&&e.data.value?(u.applyCouponSuccess(p,e.data.formatted_code,e.data.value,e.data.type),o(!0)):(u.showError(p,a),s(a))},error(){u.showError(p,a),s(a)},complete(){e.removeClass(u.classes.applyingCoupon)}})):(u.showError(p,a),s(a))}})},beforePageChange(o,e,s,r){if(console.warn('WARNING! Function "WPFormsCoupons.beforePageChange( e, nextPage, $form, action )" has been deprecated'),"next"===r){const t=i(o.target);s.find(".wpforms-page:visible").find(u.selectors.couponInput).each(function(){var e=i(this);u.isEmptyField(e)||u.hasCoupon(e)||(o.preventDefault(),u.applyCoupon(e.closest(u.selectors.field)).then(function(){wpforms.pagebreakNav(t)}).catch(u.showDebugMessage))})}},onPayPalCommerceSubmit(o,s){console.warn('WARNING! Function "WPFormsCoupons.onPayPalCommerceSubmit( e, $form )" has been deprecated'),u.removePayPalCommerceNotice(),s.find(u.selectors.couponInput).each(function(){var e=i(this);u.isEmptyField(e)||u.hasCoupon(e)||(o.preventDefault(),u.applyCoupon(e.closest(u.selectors.field)).then(function(){var e=s.find(".wpforms-submit");WPFormsPaypalCommerce.isCheckoutSelected(s)?e.closest(".wpforms-submit-container").before('<div class="wpforms-info wpforms-notice '+u.classes.payPalCommerceNoticeClass+'">'+wpforms_settings.ppc_applied_coupon+"</div>"):e.click()}).catch(u.showDebugMessage))})},hasCoupon(e){console.warn('WARNING! Function "WPFormsCoupons.hasCoupon( $couponInput )" has been deprecated');e=e.closest(u.selectors.couponRow);return e.hasClass(u.classes.hasAppliedCoupons)||e.hasClass(u.classes.applyingCoupon)},removePayPalCommerceNotice(){console.warn('WARNING! Function "WPFormsCoupons.removePayPalCommerceNotice()" has been deprecated'),i(u.selectors.payPalCommerceNotice).remove()}};return u}(document,window,jQuery);WPFormsCoupons.init();